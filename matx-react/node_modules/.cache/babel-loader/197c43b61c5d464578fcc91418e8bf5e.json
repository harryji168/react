{"ast":null,"code":"var _jsxFileName = \"/home/harryji/react/matx-react/src/app/contexts/JWTAuthContext.js\";\nimport React, { createContext, useEffect, useReducer } from 'react';\nimport jwtDecode from 'jwt-decode';\nimport axios from 'axios.js';\nimport { MatxLoading } from 'app/components';\nconst initialState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null\n};\n\nconst isValidToken = accessToken => {\n  if (!accessToken) {\n    return false;\n  }\n\n  const decodedToken = jwtDecode(accessToken);\n  const currentTime = Date.now() / 1000;\n  console.log(decodedToken);\n  return decodedToken.exp > currentTime;\n};\n\nconst setSession = accessToken => {\n  if (accessToken) {\n    localStorage.setItem('accessToken', accessToken);\n    axios.defaults.headers.common.Authorization = \"Bearer \".concat(accessToken);\n  } else {\n    localStorage.removeItem('accessToken');\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\n\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case 'INIT':\n      {\n        const {\n          isAuthenticated,\n          user\n        } = action.payload;\n        return { ...state,\n          isAuthenticated,\n          isInitialised: true,\n          user\n        };\n      }\n\n    case 'LOGIN':\n      {\n        const {\n          user\n        } = action.payload;\n        return { ...state,\n          isAuthenticated: true,\n          user\n        };\n      }\n\n    case 'LOGOUT':\n      {\n        return { ...state,\n          isAuthenticated: false,\n          user: null\n        };\n      }\n\n    case 'REGISTER':\n      {\n        const {\n          user\n        } = action.payload;\n        return { ...state,\n          isAuthenticated: true,\n          user\n        };\n      }\n\n    default:\n      {\n        return { ...state\n        };\n      }\n  }\n};\n\nconst AuthContext = createContext({ ...initialState,\n  method: 'JWT',\n  login: () => Promise.resolve(),\n  logout: () => {},\n  register: () => Promise.resolve()\n});\nexport const AuthProvider = _ref => {\n  let {\n    children\n  } = _ref;\n  const [state, dispatch] = useReducer(reducer, initialState);\n\n  const login = async (email, password) => {\n    const response = await axios.post('/api/auth/login', {\n      email,\n      password\n    });\n    const {\n      accessToken,\n      user\n    } = response.data;\n    setSession(accessToken);\n    dispatch({\n      type: 'LOGIN',\n      payload: {\n        user\n      }\n    });\n  };\n\n  const register = async (email, username, password) => {\n    const response = await axios.post('/api/auth/register', {\n      email,\n      username,\n      password\n    });\n    const {\n      accessToken,\n      user\n    } = response.data;\n    setSession(accessToken);\n    dispatch({\n      type: 'REGISTER',\n      payload: {\n        user\n      }\n    });\n  };\n\n  const logout = () => {\n    setSession(null);\n    dispatch({\n      type: 'LOGOUT'\n    });\n  };\n\n  useEffect(() => {\n    ;\n\n    (async () => {\n      try {\n        const accessToken = window.localStorage.getItem('accessToken');\n\n        if (accessToken && isValidToken(accessToken)) {\n          setSession(accessToken);\n          const response = await axios.get('/api/auth/profile');\n          const {\n            user\n          } = response.data;\n          dispatch({\n            type: 'INIT',\n            payload: {\n              isAuthenticated: true,\n              user\n            }\n          });\n        } else {\n          dispatch({\n            type: 'INIT',\n            payload: {\n              isAuthenticated: false,\n              user: null\n            }\n          });\n        }\n      } catch (err) {\n        console.error(err);\n        dispatch({\n          type: 'INIT',\n          payload: {\n            isAuthenticated: false,\n            user: null\n          }\n        });\n      }\n    })();\n  }, []);\n\n  if (!state.isInitialised) {\n    return /*#__PURE__*/React.createElement(MatxLoading, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 168,\n        columnNumber: 16\n      }\n    });\n  }\n\n  return /*#__PURE__*/React.createElement(AuthContext.Provider, {\n    value: { ...state,\n      method: 'JWT',\n      login,\n      logout,\n      register\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 172,\n      columnNumber: 9\n    }\n  }, children);\n};\nexport default AuthContext;","map":{"version":3,"sources":["/home/harryji/react/matx-react/src/app/contexts/JWTAuthContext.js"],"names":["React","createContext","useEffect","useReducer","jwtDecode","axios","MatxLoading","initialState","isAuthenticated","isInitialised","user","isValidToken","accessToken","decodedToken","currentTime","Date","now","console","log","exp","setSession","localStorage","setItem","defaults","headers","common","Authorization","removeItem","reducer","state","action","type","payload","AuthContext","method","login","Promise","resolve","logout","register","AuthProvider","children","dispatch","email","password","response","post","data","username","window","getItem","get","err","error"],"mappings":"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","sourcesContent":["import React, { createContext, useEffect, useReducer } from 'react'\nimport jwtDecode from 'jwt-decode'\nimport axios from 'axios.js'\nimport { MatxLoading } from 'app/components'\n\nconst initialState = {\n    isAuthenticated: false,\n    isInitialised: false,\n    user: null,\n}\n\nconst isValidToken = (accessToken) => {\n    if (!accessToken) {\n        return false\n    }\n\n    const decodedToken = jwtDecode(accessToken)\n    const currentTime = Date.now() / 1000\n    console.log(decodedToken)\n    return decodedToken.exp > currentTime\n}\n\nconst setSession = (accessToken) => {\n    if (accessToken) {\n        localStorage.setItem('accessToken', accessToken)\n        axios.defaults.headers.common.Authorization = `Bearer ${accessToken}`\n    } else {\n        localStorage.removeItem('accessToken')\n        delete axios.defaults.headers.common.Authorization\n    }\n}\n\nconst reducer = (state, action) => {\n    switch (action.type) {\n        case 'INIT': {\n            const { isAuthenticated, user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated,\n                isInitialised: true,\n                user,\n            }\n        }\n        case 'LOGIN': {\n            const { user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated: true,\n                user,\n            }\n        }\n        case 'LOGOUT': {\n            return {\n                ...state,\n                isAuthenticated: false,\n                user: null,\n            }\n        }\n        case 'REGISTER': {\n            const { user } = action.payload\n\n            return {\n                ...state,\n                isAuthenticated: true,\n                user,\n            }\n        }\n        default: {\n            return { ...state }\n        }\n    }\n}\n\nconst AuthContext = createContext({\n    ...initialState,\n    method: 'JWT',\n    login: () => Promise.resolve(),\n    logout: () => {},\n    register: () => Promise.resolve(),\n})\n\nexport const AuthProvider = ({ children }) => {\n    const [state, dispatch] = useReducer(reducer, initialState)\n\n    const login = async (email, password) => {\n        const response = await axios.post('/api/auth/login', {\n            email,\n            password,\n        })\n        const { accessToken, user } = response.data\n\n        setSession(accessToken)\n\n        dispatch({\n            type: 'LOGIN',\n            payload: {\n                user,\n            },\n        })\n    }\n\n    const register = async (email, username, password) => {\n        const response = await axios.post('/api/auth/register', {\n            email,\n            username,\n            password,\n        })\n\n        const { accessToken, user } = response.data\n\n        setSession(accessToken)\n\n        dispatch({\n            type: 'REGISTER',\n            payload: {\n                user,\n            },\n        })\n    }\n\n    const logout = () => {\n        setSession(null)\n        dispatch({ type: 'LOGOUT' })\n    }\n\n    useEffect(() => {\n        ;(async () => {\n            try {\n                const accessToken = window.localStorage.getItem('accessToken')\n\n                if (accessToken && isValidToken(accessToken)) {\n                    setSession(accessToken)\n                    const response = await axios.get('/api/auth/profile')\n                    const { user } = response.data\n\n                    dispatch({\n                        type: 'INIT',\n                        payload: {\n                            isAuthenticated: true,\n                            user,\n                        },\n                    })\n                } else {\n                    dispatch({\n                        type: 'INIT',\n                        payload: {\n                            isAuthenticated: false,\n                            user: null,\n                        },\n                    })\n                }\n            } catch (err) {\n                console.error(err)\n                dispatch({\n                    type: 'INIT',\n                    payload: {\n                        isAuthenticated: false,\n                        user: null,\n                    },\n                })\n            }\n        })()\n    }, [])\n\n    if (!state.isInitialised) {\n        return <MatxLoading />\n    }\n\n    return (\n        <AuthContext.Provider\n            value={{\n                ...state,\n                method: 'JWT',\n                login,\n                logout,\n                register,\n            }}\n        >\n            {children}\n        </AuthContext.Provider>\n    )\n}\n\nexport default AuthContext\n"]},"metadata":{},"sourceType":"module"}